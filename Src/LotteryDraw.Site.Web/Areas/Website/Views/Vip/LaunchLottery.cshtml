@{
    ViewBag.Title = "LaunchLottery";
    Layout = "~/Areas/Website/Views/Shared/_Layout_Vip.cshtml";
}
@using Webdiyer.WebControls.Mvc
@model LotteryDraw.Site.Models.PrizeOrderDetailView

@section  LeftMenuItems{
    @Html.Partial("VipNavPartial")
}

@section  BreadCrumbs{
    &gt;
    <label>发布抽奖</label>
}

@using (Html.BeginForm("PublishPrizeAjax", "Vip", FormMethod.Post, new { id = "prizeForm" }))
{
    //enctype = "multipart/form-data"
    string rtype = ViewBag.RevealType;
    @Html.Hidden("hidnRevealType", rtype)
    @Html.HiddenFor(m => m.PrizeOrderView.MinLuckyCount)
    @Html.HiddenFor(m => m.PrizeOrderView.RevealType);
    @Html.HiddenFor(m => m.PrizeOrderView.RevealTypeNum);
    @Html.HiddenFor(m => m.PrizeOrderView.AnswerRevealConditionTypeNum);
    @Html.HiddenFor(m => m.PrizeOrderView.Answer);
    @Html.HiddenFor(m => m.PrizeOrderView.AnswerOptions);
    @Html.HiddenFor(model => model.PrizeOrderView.PrizeId)
    <table class="message_table">
        <tbody>
            @*@if (ViewBag.IsPostBack != null && (bool)ViewBag.IsPostBack)
            {
                <tr>
                    <td colspan="2" style="text-align: center; color: #f00;">@ViewBag.Message</td>
                </tr>
            }*@
            <tr rtype="no-change">
                <td class="text">奖品名称</td>
                <td class="input">
                    @Html.TextBoxFor(model => model.PrizeView.Name, new { @class = "input-text", placeholder = "奖品名称" })
                    <span class="info">*</span>
                    <br />
                </td>
            </tr>
            <tr rtype="no-change">
                <td class="text">奖品图片</td>
                <td class="input">
                    <input type="file" id="prizePhoto" name="PrizePhoto" />
                    <div id="divPreview" style="background-color: #ccc; text-align: center; vertical-align: middle;">
                        <img id="imgHeadPhoto" style="display: none; max-width: 400px;" alt="" />
                    </div>
                    @*<input type="button" value="浏览" style="padding:5px;width:60px;" id="btnBrowerPhoto" />
                    <input type="file" id="prizePhoto" name="PrizePhoto" />*@
                </td>
            </tr>
            <tr rtype="no-change">
                <td class="text">描述：</td>
                <td class="input">
                    @Html.TextAreaFor(model => model.PrizeView.Description, new { @class = "textarea-text", cols = "50", rows = "6", placeholder = "描述" })
                    <br />
                </td>
            </tr>
            <tr rtype="no-change">
                <td class="text">开奖类型：</td>
                <td class="input">
                    @*@Html.DropDownList("slLauchType",(SelectList)ViewBag.RevealTypeList)*@
                    <select id="slLauchType">
                        <option value="" rtype="">请选择</option>
                        <option value="1" rtype="timing">定时开奖</option>
                        <option value="2" rtype="quota">定员开奖</option>
                        <option value="3" rtype="answer">答案开奖</option>
                        <option value="4" rtype="scene">实时开奖</option>
                    </select>
                </td>
            </tr>
            <tr rtype="timing quota answer">
                <td class="text">抽奖范围：</td>
                <td class="input">
                    @Html.TextBoxFor(m => m.PrizeOrderView.LuckyCount, new { @class = "input-text num" })<span class="info">*</span>
                </td>
            </tr>
            <tr rtype="timing quota answer scene">
                <td class="text">中奖人数：</td>
                <td class="input">
                    @Html.TextBoxFor(m => m.PrizeOrderView.LuckyCount, new { @class = "input-text num" })<span class="info">*</span>
                </td>
            </tr>
            <tr rtype="answer">
                <td class="text">开奖问题：</td>
                <td class="input">
                    @Html.TextAreaFor(m => m.PrizeOrderView.Question, new { @class = "textarea-text", cols = "50", rows = "3" })<span class="info">*</span>
                </td>
            </tr>
            <tr rtype="answer">
                <td class="text">答案选项：</td>
                <td class="input">
                    <div style="float: left;">
                        @*@Html.TextAreaFor(m => m.Answer, new { @class = "textarea-text", cols = "50", rows = "3" })*@
                        <input type="text" class="input-text" id="txtAnswerOption" />
                        <input type="button" class="" value="&nbsp;>>&nbsp;" id="btnAddAnswerOption" />
                    </div>
                    <div style="float: left;">
                        <div class="dropdown">
                        </div>
                    </div>
                    @Html.Hidden("AddedAnswerOptions")
                </td>
            </tr>
            <tr rtype="answer">
                <td class="text">开奖答案：</td>
                <td class="input">
                    <select id="slAnswer" name="slAnswer">
                        <option value="" selected>请选择</option>
                    </select><span class="info">*</span><input type="button" class="button orange" value="重置" id="btnResetAnswerOption" />
                </td>
            </tr>
            <tr rtype="answer">
                <td class="text">开奖条件：</td>
                <td class="input">
                    @*@Html.DropDownList("slLauchType",(SelectList)ViewBag.RevealTypeList)*@
                    <select id="slAnswerLauchType" name="AnswerLauchType">
                        <option value="" selected>请选择</option>
                        <option value="1" trid="trLaunchTime">定时</option>
                        <option value="2" trid="trPoolCount">定员</option>
                    </select><span class="info">*</span>
                </td>
            </tr>
            <tr rtype="quota">
                <td class="text">总人数：</td>
                <td class="input">
                    @Html.TextBoxFor(m => m.PrizeOrderView.PoolCount, new { @class = "input-text num" })<span class="info">*</span>
                </td>
            </tr>
            <tr rtype="timing scene">
                <td class="text">开奖时间：</td>
                <td class="input">
                    @Html.TextBoxFor(m => m.PrizeOrderView.LaunchTime, new { @class = "input-text launchtime", id = "txtLaunchTime", @readonly = "readonly" })<span class="info">*</span>
                </td>
            </tr>
            @*<tr>
                    <td class="text">中奖最低人数：</td>
                    <td class="input">
                        @Html.TextBoxFor(m => m.PrizeOrderView.MinLuckyCount, new { @class = "input-text num" })<span class="info">*</span>
                    </td>
                </tr>*@
            <tr rtype="no-change">
                <td class="text"></td>
                <td class="input">
                    @Html.MvcCaptcha(new MvcCaptchaOptions
               {
                   DelayLoad = false, //若要启用Ajax延迟加载验证码图片功能，则需要设置MvcCaptchaOptions属性的DelayLoad为true
                   ValidationInputBoxId = "captchaInput", //验证码输入文本框的客户端ID
                   CaptchaImageContainerId = "imgContainer" //包含验证码图片的容器元素的客户端ID
               })
                    <span id="imgContainer"></span>
                    <br />
                    <div>请输入上边图片中的文字：</div>
                    <input type="text" class="input-text" name="_mvcCaptchaText" id="captchaInput" data-val="true" data-val-required="验证码不能为空" />
                </td>
            </tr>
            <tr rtype="no-change">
                <td class="text"></td>
                <td class="submint">
                    <input type="submit" value="发布" class="submit button orange"></td>
            </tr>
        </tbody>
    </table>
}
@using (Html.BeginForm("SavePhotoAjax", "Vip", FormMethod.Post, new { id = "photoForm", enctype = "multipart/form-data", style = "display:none" }))
{
    @Html.Hidden("PrizeId")
    <table class="message_table">
        <tr>
            <td class="text">奖品图片</td>
            <td class="input">
                <input type="file" id="prizePhoto" name="PrizePhoto" />
                <div id="divPreview" style="background-color: #ccc; text-align: center; vertical-align: middle;">
                    <img id="imgHeadPhoto" style="display: none; max-width: 400px;" alt="" />
                </div>
            </td>
        </tr>
        <tr>
            <td class="text"></td>
            <td class="submint">
                <input type="submit" value="上传" class="submit button orange"></td>
        </tr>
    </table>
}
@section scripts{
    @Html.Partial("PostBackMessage")
    <script src="~/Scripts/jquery.form.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.maskedinput.min.js"></script>
    <script src="~/Scripts/jquery.previewimage.js"></script>
    <script src="~/Content/website/js/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript">
        $(function () {
            //初始化日期选择控件
            $(".launchtime").focus(function () {
                WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm:ss' })
            });

            //限制文本框只能输入数字
            $(".num").live("keyup", function () {
                $(this).val($(this).val().replace(/\D/g, ''));
            }).live("afterpaste", function () {
                $(this).val($(this).val().replace(/\D/g, ''));
            });

            // 开奖类型下拉框事件
            $("#slLauchType").change(function () {
                var $opobj = $(this).find("option:selected");
                var rtype = $opobj.attr("rtype");
                $("#hidnRevealType").val($(this).val())
                // 不是公用的部分先全部隐藏掉
                $("form#prizeForm tr[rtype!='no-change']").hide();
                if (rtype == "")
                    return;
                // 本抽奖类型相关的 表单项都现实出来
                $("form#prizeForm tr[rtype*='" + rtype + "']").fadeIn();
            });

            $("#btnAddAnswerOption").click(function () {
                if ($("#txtAnswerOption").val() == "") {
                    alert("答案不能为空");
                    return;
                }

                //数字转字母
                var opcount = $("#slAnswer option[class='answer']").length;
                var opvalue = String.fromCharCode((opcount) + 65);
                var optionString = "<option class=\"answer\" value=" + opvalue + ">" + $("#txtAnswerOption").val() + "</option>"
                $("#listAnswerOptions").append(optionString)
                $("#slAnswer").append(optionString);
                $('.dropdown').append("<div class=\"dropdown-item\" value=" + opvalue + ">" + opvalue + ":" + $("#txtAnswerOption").val() + "<span>X</span></div>");
                $("#txtAnswerOption").val("");
            });

            $("#btnResetAnswerOption").click(function () {
                $("#slAnswer option[class='answer']").remove();
                $("div.dropdown div.dropdown-item").remove();
            });

            $("#txtAnswerOption").keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13') {
                    $("#btnAddAnswerOption").trigger("click");
                }
            });

            $("div.dropdown-item").live("hover", function (event) {
                if (event.type == 'mouseenter') {
                    $(this).addClass("selected");
                    $(this).find("span").show();
                } else {
                    $(this).removeClass("selected");
                    $(this).find("span").hide();
                }
            });

            $("div.dropdown-item span").live("click", function () {
                var value = $(this).parent().attr("value");
                $(this).parent().remove();
                $("#slAnswer option[value=" + value + "]").remove();

                $('.dropdown div.dropdown-item').remove();
                var icounter = 0;
                $("#slAnswer option[class='answer']").each(function () {
                    //数字转字母
                    var opvalue = String.fromCharCode((icounter++) + 65);
                    $(this).attr("value", opvalue);
                    var divOPString = "<div class=\"dropdown-item\" value=" + opvalue + ">" + opvalue + ":" + $(this).html() + "<span>X</span></div>";
                    $('.dropdown').append(divOPString);
                });
            });

            $("#btnBrowerPhoto").click(function () {
                //文件上传
                //layer.prompt({ title: '随便上传个东东，并确认', type: 2 }, function (file) {
                //    console.debug(file);
                //    alert(file);
                //});
                $.layer({
                    type: 1,   //0-4的选择,
                    area: ['500px', '300px'],
                    shade: [0],  //不使用遮罩
                    maxmin: true,   //开启最小化/全屏
                    offset: ['100px', ''],
                    page: {
                        html: '<div><form action="intTpmsPurRegsn.do?action=uploadXls" enctype="multipart/form-data"><input type="file" name="xlsFile"/></form><input type="submit" value="提交"/></div>'
                    },
                    success: function () {
                        layer.shift('top'); //动画从上掉下
                    }
                });
            });
            $("#prizeForm").validate({
                errorElement: 'span',
                errorClass: 'error-info',
                focusInvalid: false,
                rules: {
                    Name: {
                        required: true
                    }
                },

                messages: {
                    Name: {
                        required: "奖品名称不能为空"
                    }
                },
                invalidHandler: function (event, validator) { //display error alert on form submit   
                    //$('.alert-danger', $('.login-form')).show();
                },
                highlight: function (e) {
                    //$(e).closest('.form-group').removeClass('has-info').addClass('has-error');
                },
                /* 验证通过时的处理 */
                success: function (e) {
                    //$(e).closest('.form-group').removeClass('has-error').addClass('has-info');
                    //$(e).remove();
                },
                /* 错误信息的显示位置 */
                errorPlacement: function (error, element) {
                    //element.parent().append("<br />");
                    error.appendTo(element.parent());
                },
                /*执行ajaxsubmit*/
                submitHandler: function (form) {
                    //form.submit();
                    var loadi;
                    $(form).ajaxSubmit({
                        type: "post",
                        dataType: "json", //期望返回的数据类型。null、“xml”、“script”或者“json”其中之一
                        //url: "test_save.php?time=" + (new Date()).getTime(),
                        beforeSubmit: function () {
                            loadi = layer.load('正在提交数据库，请耐心等待…');
                        },
                        success: function (data) {
                            var result = data.OK;
                            var message = data.Message;
                            if (!result) {
                                layer.alert(message, 8);
                                $("#abtnChangeCaptcha").trigger("click");
                                return;
                            }
                            layer.confirm("奖品信息保存成功，是否同时上传图片？", function (index) {
                                layer.close(index);
                                var pid = data.PrizeId;
                                $("#PrizeId").val(pid);
                                $("#prizeForm").hide();
                                $("#photoForm").fadeIn();
                                // 显示上传图片
                            }, function () { });
                        }
                        ,
                        error: function () {

                        },
                        complete: function () {
                            layer.close(loadi);
                        }
                    });
                }
            });

            $("#photoForm").submit(function () {
                var loadi;
                $(this).ajaxSubmit({
                    type: "post",
                    //dataType: "xml", //期望返回的数据类型。null、“xml”、“script”或者“json”其中之一
                    //url: "test_save.php?time=" + (new Date()).getTime(),
                    beforeSubmit: function () {
                        loadi = layer.load('正在上传图片，请耐心等待…');
                    },
                    success: function (data) {
                        var result = data.OK;
                        var message = data.Message;
                        if (!result) {
                            layer.alert(message, 8);
                            return;
                        }
                        layer.alert(message, 9);
                    },
                    error: function () {

                    },
                    complete: function () {
                        layer.close(loadi);
                    }
                });
                return false;
            });

            $("#prizePhoto").PreviewImage({
                ImageClientId: "imgHeadPhoto",
                MaxWidth: 300,
                MaxHeight: 200,
                DivPreviewId: "divPreview",
                AllowExtention: ".jpg,.bmp,.gif,.png"
            });

            // 初始化选中抽奖类型
            locateSelect();
        });

        function locateSelect() {
            var rtype = $("#hidnRevealType").val();
            $("#slLauchType option").each(function () {
                var $option = $(this);
                var rtvalue = $option.val();

                if ($.trim(rtvalue) == rtype) {
                    $option.attr("selected", true);
                    $("#slLauchType").trigger("change");
                    return false; // false时相当于break, 如果return true 就相当于continure。
                }
            });
        }
    </script>
}
@section  styles{
    <style type="text/css">
        body {
            behavior: url("../../../Content/website/css/csshover.htc");
        }

        div.row-container {
        }

        div.formdata {
            display: none;
        }

        input[type=text].num {
            width: 30px;
        }

        /*发起抽奖页面*/
        div.dropdown {
            height: 200px;
            width: 200px;
            overflow-y: scroll;
            border: solid 1px silver;
            padding: 5px;
        }

            div.dropdown .dropdown-item {
                cursor: pointer;
                position: relative;
            }

                div.dropdown .dropdown-item:hover {
                    background: #C6D7EF;
                    color: #000;
                }

            div.dropdown span {
                position: absolute;
                right: 5px;
                display: none;
            }

                div.dropdown span:hover {
                    color: #f00;
                    font-weight: bold;
                }

            div.dropdown .selected {
                background: #C6D7EF;
                color: #000;
            }
    </style>
}